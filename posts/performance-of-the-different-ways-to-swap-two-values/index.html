<!doctype html><html class=no-js lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><title>Performance of the different ways to swap two values - Tearth's homepage</title><script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script><meta name=description content="What are the differences between swapping two values using a temporary variable, XOR operations and tuple-based assignments."><meta property="og:title" content="Performance of the different ways to swap two values"><meta property="og:description" content="What are the differences between swapping two values using a temporary variable, XOR operations and tuple-based assignments."><meta property="og:type" content="article"><meta property="og:url" content="https://tearth.dev/posts/performance-of-the-different-ways-to-swap-two-values/"><meta property="og:image" content="https://tearth.dev/img/card.jpg"><meta property="article:published_time" content="2020-07-25T00:00:00+00:00"><meta property="article:modified_time" content="2020-07-25T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://tearth.dev/img/card.jpg"><meta name=twitter:title content="Performance of the different ways to swap two values"><meta name=twitter:description content="What are the differences between swapping two values using a temporary variable, XOR operations and tuple-based assignments."><link rel=dns-prefetch href=//fonts.googleapis.com><link rel=dns-prefetch href=//fonts.gstatic.com><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700"><link rel=stylesheet href=/css/bundle.min.css><link rel="shortcut icon" href=/favicon.ico><script defer src=https://b.tearth.dev/script.js data-website-id=0f32476c-b2f9-4123-8feb-771a0e3f5463></script></head><body class=body><div class="container container--outer"><header class=header><div class="container header__container"><div class=logo><a class=logo__link href=/ title="Tearth's homepage" rel=home><div class=logo__title>Tearth's homepage</div><div class=logo__tagline>Loosely updated site about everything I enjoy</div></a></div><div class=divider></div></div></header><div class="wrapper flex"><div class=primary><main class=main role=main><article class=post><header class=post__header><h1 class=post__title>Performance of the different ways to swap two values</h1><div class="post__meta meta"><div class="meta__item-datetime meta__item"><svg class="meta__icon icon icon-time" width="16" height="14" viewBox="0 0 30 28"><path d="M15 0C7 0 1 6 1 14s6 14 14 14 14-6 14-14S23 0 15 0zm0 25C9 25 4 20 4 14S9 3 15 3s11 5 11 11-5 11-11 11zm1-18h-2v8.4l6.8 4.4L22 18l-6-3.8V7z"/></svg><time class=meta__text datetime=2020-07-25T00:00:00Z>2020-07-25</time></div><div class="meta__item-categories meta__item"><svg class="meta__icon icon icon-category" width="16" height="16" viewBox="0 0 16 16"><path d="m7 2 1 2h8v11H0V2z"/></svg><span class=meta__text><a class=meta__link href=/categories/.net-internals/ rel=category>.NET internals</a>, <a class=meta__link href=/categories/performance-comparisons/ rel=category>Performance comparisons</a></span></div></div></header><div class="post__toc toc"><div class=toc__title>Page content</div><div class=toc__menu><nav id=TableOfContents><ul><li><a href=#theory>Theory</a></li><li><a href=#benchmark>Benchmark</a></li><li><a href=#bubble-sort>Bubble sort</a></li><li><a href=#summary>Summary</a></li></ul></nav></div></div><div class="content post__content clearfix"><p>Swapping values is probably one of the simplest algorithms which can be imagined - we learn about it when starting our programming story. There are two popular ways to accomplish this: using a temporary variable and XORing (with some restrictions). In the newest C# versions there is also a third way, about which you can read in this article.</p><h2 id=theory>Theory</h2><p>A few weeks ago, one of my friends sent me this tweet from which we will start:</p><blockquote class=twitter-tweet><p lang=en dir=ltr>(and yes, this works, for both value types and reference types, it's not a shitpost I promise~)<br><br>it defines a tuple on the right, then immediately deconstructs it into the already defined a and b variables<a href=https://t.co/i0UeEyBfZA>https://t.co/i0UeEyBfZA</a></p>&mdash; Freya Holm√©r (@FreyaHolmer) <a href="https://twitter.com/FreyaHolmer/status/1283000617510854656?ref_src=twsrc%5Etfw">July 14, 2020</a></blockquote><script async src=https://platform.twitter.com/widgets.js></script><p>What do we see here is the usage of the value tuples syntax (introduced in the C# 7) to swap two values. As the description says, first we create a tuple with our two variables (on the right side of the assignment) and then it&rsquo;s instantly deconstructed into the second tuple (on the left side of the assignment) but in reversed order. It was quite surprising as I never thought about using tuples this way, but at the same time, I was curious if this solution has some performance overhead.</p><p>On the one side, we use here <a href="https://docs.microsoft.com/en-us/dotnet/api/system.valuetuple?view=netcore-3.1">ValueTuple</a> struct, so it&rsquo;s not an overhead for garbage collector - values are stored on the stack and will be just wiped after exiting from the method. On the other hand, we don&rsquo;t know if the compiler will generate some extra IL instructions compared to the traditional swap using a temporary variable. Let&rsquo;s check it on the simple example.</p><h2 id=benchmark>Benchmark</h2><p>As in the previous articles, I used <a href=https://github.com/dotnet/BenchmarkDotNet>BenchmarkDotNet</a> library which is extremally handful when measuring performance and checking output generated by the JIT. Our benchmark is very simple and swaps two variables utilizing three different methods: through temporary variable, through XOR operations, and tuples (like on the tweet above). Additional assignments on the beginning and the end of each test are made to ensure, that compiler/JIT will make these operations using registers to maximize performance.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>using</span> <span class=nn>BenchmarkDotNet.Attributes</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>BenchmarkDotNet.Jobs</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>BenchmarkDotNet.Running</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>SwapBenchmark</span>
<span class=p>{</span>
<span class=na>    [DisassemblyDiagnoser]</span>
<span class=na>    [SimpleJob(RuntimeMoniker.NetCoreApp31)]</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>SwapTest</span>
    <span class=p>{</span>
        <span class=k>private</span> <span class=k>static</span> <span class=n>volatile</span> <span class=kt>int</span> <span class=n>A</span> <span class=p>=</span> <span class=m>10</span><span class=p>;</span>
        <span class=k>private</span> <span class=k>static</span> <span class=n>volatile</span> <span class=kt>int</span> <span class=n>B</span> <span class=p>=</span> <span class=m>20</span><span class=p>;</span>
<span class=na>
</span><span class=na>        [Benchmark]</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>SwapTraditional</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=kt>var</span> <span class=n>a</span> <span class=p>=</span> <span class=n>A</span><span class=p>;</span>
            <span class=kt>var</span> <span class=n>b</span> <span class=p>=</span> <span class=n>B</span><span class=p>;</span>

            <span class=kt>var</span> <span class=n>temp</span> <span class=p>=</span> <span class=n>a</span><span class=p>;</span>
            <span class=n>a</span> <span class=p>=</span> <span class=n>b</span><span class=p>;</span>
            <span class=n>b</span> <span class=p>=</span> <span class=n>temp</span><span class=p>;</span>

            <span class=n>A</span> <span class=p>=</span> <span class=n>a</span><span class=p>;</span>
            <span class=n>B</span> <span class=p>=</span> <span class=n>b</span><span class=p>;</span>
        <span class=p>}</span>
<span class=na>
</span><span class=na>        [Benchmark]</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>SwapXor</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=kt>var</span> <span class=n>a</span> <span class=p>=</span> <span class=n>A</span><span class=p>;</span>
            <span class=kt>var</span> <span class=n>b</span> <span class=p>=</span> <span class=n>B</span><span class=p>;</span>

            <span class=n>a</span> <span class=p>^=</span> <span class=n>b</span><span class=p>;</span>
            <span class=n>b</span> <span class=p>^=</span> <span class=n>a</span><span class=p>;</span>
            <span class=n>a</span> <span class=p>^=</span> <span class=n>b</span><span class=p>;</span>

            <span class=n>A</span> <span class=p>=</span> <span class=n>a</span><span class=p>;</span>
            <span class=n>B</span> <span class=p>=</span> <span class=n>b</span><span class=p>;</span>
        <span class=p>}</span>
<span class=na>
</span><span class=na>        [Benchmark]</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>SwapTuples</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=kt>var</span> <span class=n>a</span> <span class=p>=</span> <span class=n>A</span><span class=p>;</span>
            <span class=kt>var</span> <span class=n>b</span> <span class=p>=</span> <span class=n>B</span><span class=p>;</span>

            <span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>)</span> <span class=p>=</span> <span class=p>(</span><span class=n>b</span><span class=p>,</span> <span class=n>a</span><span class=p>);</span>

            <span class=n>A</span> <span class=p>=</span> <span class=n>a</span><span class=p>;</span>
            <span class=n>B</span> <span class=p>=</span> <span class=n>b</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>class</span> <span class=nc>Program</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>(</span><span class=kt>string</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>BenchmarkRunner</span><span class=p>.</span><span class=n>Run</span><span class=p>&lt;</span><span class=n>SwapTest</span><span class=p>&gt;();</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>Let&rsquo;s check the IL output first. Our first method <code>SwapTraditional</code> is straightforward and in fact uses only four instructions:</p><ul><li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.ldsfld?view=netcore-3.1">ldsfld</a> - loads static field onto the stack.</li><li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.stsfld?view=netcore-3.1">stsfld</a> - pops variable from the stack and stores it into the static field.</li><li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.ldloc?view=netcore-3.1">ldloc.x</a> - loads local variable and stores it onto the stack at the specified index (x).</li><li><a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.stloc?view=netcore-3.1">stloc.x</a> - pops variable from the stack and stores it into the local variables list at the specified index (x).</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-csharp data-lang=csharp>  <span class=p>.</span><span class=n>method</span> <span class=k>public</span> <span class=n>hidebysig</span> <span class=n>instance</span> <span class=k>void</span>
    <span class=n>SwapTraditional</span><span class=p>()</span> <span class=n>cil</span> <span class=n>managed</span>
  <span class=p>{</span>
    <span class=p>.</span><span class=n>custom</span> <span class=n>instance</span> <span class=k>void</span> <span class=p>[</span><span class=n>BenchmarkDotNet</span><span class=p>.</span><span class=n>Annotations</span><span class=p>]</span><span class=n>BenchmarkDotNet</span><span class=p>.</span><span class=n>Attributes</span><span class=p>.</span><span class=n>BenchmarkAttribute</span><span class=p>::.</span><span class=n>ctor</span><span class=p>()</span>
      <span class=p>=</span> <span class=p>(</span><span class=m>01</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=p>)</span>
    <span class=p>.</span><span class=n>maxstack</span> <span class=m>2</span>
    <span class=p>.</span><span class=n>locals</span> <span class=n>init</span> <span class=p>(</span>
<span class=na>      [0]</span> <span class=n>int32</span> <span class=n>a</span><span class=p>,</span>
<span class=na>      [1]</span> <span class=n>int32</span> <span class=n>temp</span>
    <span class=p>)</span>

    <span class=c1>// [17 13 - 17 23]
</span><span class=c1></span>    <span class=n>IL_0000</span><span class=p>:</span> <span class=n>volatile</span><span class=p>.</span>
    <span class=n>IL_0002</span><span class=p>:</span> <span class=n>ldsfld</span>       <span class=n>int32</span> <span class=n>modreq</span> <span class=p>([</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>]</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>CompilerServices</span><span class=p>.</span><span class=n>IsVolatile</span><span class=p>)</span> <span class=n>SwapBenchmark</span><span class=p>.</span><span class=n>SwapTest</span><span class=p>::</span><span class=n>A</span>
    <span class=n>IL_0007</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>
    <span class=c1>// [18 13 - 18 23]
</span><span class=c1></span>    <span class=n>IL_0008</span><span class=p>:</span> <span class=n>volatile</span><span class=p>.</span>
    <span class=n>IL_000a</span><span class=p>:</span> <span class=n>ldsfld</span>       <span class=n>int32</span> <span class=n>modreq</span> <span class=p>([</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>]</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>CompilerServices</span><span class=p>.</span><span class=n>IsVolatile</span><span class=p>)</span> <span class=n>SwapBenchmark</span><span class=p>.</span><span class=n>SwapTest</span><span class=p>::</span><span class=n>B</span>

    <span class=c1>// [20 13 - 20 26]
</span><span class=c1></span>    <span class=n>IL_000f</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>    <span class=n>IL_0010</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>1</span>      <span class=c1>// temp
</span><span class=c1></span>
    <span class=c1>// [21 13 - 21 19]
</span><span class=c1></span>    <span class=n>IL_0011</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>
    <span class=c1>// [22 13 - 22 22]
</span><span class=c1></span>    <span class=n>IL_0012</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>1</span>      <span class=c1>// temp
</span><span class=c1></span>
    <span class=c1>// [24 13 - 24 19]
</span><span class=c1></span>    <span class=n>IL_0013</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>    <span class=n>IL_0014</span><span class=p>:</span> <span class=n>volatile</span><span class=p>.</span>
    <span class=n>IL_0016</span><span class=p>:</span> <span class=n>stsfld</span>       <span class=n>int32</span> <span class=n>modreq</span> <span class=p>([</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>]</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>CompilerServices</span><span class=p>.</span><span class=n>IsVolatile</span><span class=p>)</span> <span class=n>SwapBenchmark</span><span class=p>.</span><span class=n>SwapTest</span><span class=p>::</span><span class=n>A</span>

    <span class=c1>// [25 13 - 25 19]
</span><span class=c1></span>    <span class=n>IL_001b</span><span class=p>:</span> <span class=n>volatile</span><span class=p>.</span>
    <span class=n>IL_001d</span><span class=p>:</span> <span class=n>stsfld</span>       <span class=n>int32</span> <span class=n>modreq</span> <span class=p>([</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>]</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>CompilerServices</span><span class=p>.</span><span class=n>IsVolatile</span><span class=p>)</span> <span class=n>SwapBenchmark</span><span class=p>.</span><span class=n>SwapTest</span><span class=p>::</span><span class=n>B</span>

    <span class=c1>// [26 9 - 26 10]
</span><span class=c1></span>    <span class=n>IL_0022</span><span class=p>:</span> <span class=n>ret</span>

  <span class=p>}</span> <span class=c1>// end of method SwapTest::SwapTraditional
</span></code></pre></td></tr></table></div></div><p>We can see the sequence of the following operations: first, the compiler loads static field <code>A</code> onto the stack and then pops it into the local variable <code>a</code>. Static field <code>B</code> is also loaded in a similar way, but it stays in the stack. Then, the local variable <code>a</code> is loaded onto the stack and immediately popped into the <code>temp</code>. Just after it, the value of the static field <code>B</code> (which has been loaded earlier) is assigned to the <code>a</code>. At this point, the local variable <code>a</code> contains value of the static field <code>B</code>, and the local variable <code>temp</code> contains the value of the <code>a</code>. The last operations are loading both of them onto the stack and popping into <code>A</code> and <code>B</code>.</p><p>Now time for the second test, which uses XOR operations. The compiler uses here the new instruction <code>xor</code> which does exactly what the name indicates - pops two variables from the stack, XORs them and stores the result again on the stack.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-csharp data-lang=csharp>  <span class=p>.</span><span class=n>method</span> <span class=k>public</span> <span class=n>hidebysig</span> <span class=n>instance</span> <span class=k>void</span>
    <span class=n>SwapXor</span><span class=p>()</span> <span class=n>cil</span> <span class=n>managed</span>
  <span class=p>{</span>
    <span class=p>.</span><span class=n>custom</span> <span class=n>instance</span> <span class=k>void</span> <span class=p>[</span><span class=n>BenchmarkDotNet</span><span class=p>.</span><span class=n>Annotations</span><span class=p>]</span><span class=n>BenchmarkDotNet</span><span class=p>.</span><span class=n>Attributes</span><span class=p>.</span><span class=n>BenchmarkAttribute</span><span class=p>::.</span><span class=n>ctor</span><span class=p>()</span>
      <span class=p>=</span> <span class=p>(</span><span class=m>01</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=p>)</span>
    <span class=p>.</span><span class=n>maxstack</span> <span class=m>2</span>
    <span class=p>.</span><span class=n>locals</span> <span class=n>init</span> <span class=p>(</span>
<span class=na>      [0]</span> <span class=n>int32</span> <span class=n>a</span><span class=p>,</span>
<span class=na>      [1]</span> <span class=n>int32</span> <span class=n>b</span>
    <span class=p>)</span>

    <span class=c1>// [31 13 - 31 23]
</span><span class=c1></span>    <span class=n>IL_0000</span><span class=p>:</span> <span class=n>volatile</span><span class=p>.</span>
    <span class=n>IL_0002</span><span class=p>:</span> <span class=n>ldsfld</span>       <span class=n>int32</span> <span class=n>modreq</span> <span class=p>([</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>]</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>CompilerServices</span><span class=p>.</span><span class=n>IsVolatile</span><span class=p>)</span> <span class=n>SwapBenchmark</span><span class=p>.</span><span class=n>SwapTest</span><span class=p>::</span><span class=n>A</span>
    <span class=n>IL_0007</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>
    <span class=c1>// [32 13 - 32 23]
</span><span class=c1></span>    <span class=n>IL_0008</span><span class=p>:</span> <span class=n>volatile</span><span class=p>.</span>
    <span class=n>IL_000a</span><span class=p>:</span> <span class=n>ldsfld</span>       <span class=n>int32</span> <span class=n>modreq</span> <span class=p>([</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>]</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>CompilerServices</span><span class=p>.</span><span class=n>IsVolatile</span><span class=p>)</span> <span class=n>SwapBenchmark</span><span class=p>.</span><span class=n>SwapTest</span><span class=p>::</span><span class=n>B</span>
    <span class=n>IL_000f</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>1</span>      <span class=c1>// b
</span><span class=c1></span>
    <span class=c1>// [34 13 - 34 20]
</span><span class=c1></span>    <span class=n>IL_0010</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>    <span class=n>IL_0011</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>1</span>      <span class=c1>// b
</span><span class=c1></span>    <span class=n>IL_0012</span><span class=p>:</span> <span class=n>xor</span>
    <span class=n>IL_0013</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>
    <span class=c1>// [35 13 - 35 20]
</span><span class=c1></span>    <span class=n>IL_0014</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>1</span>      <span class=c1>// b
</span><span class=c1></span>    <span class=n>IL_0015</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>    <span class=n>IL_0016</span><span class=p>:</span> <span class=n>xor</span>
    <span class=n>IL_0017</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>1</span>      <span class=c1>// b
</span><span class=c1></span>
    <span class=c1>// [36 13 - 36 20]
</span><span class=c1></span>    <span class=n>IL_0018</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>    <span class=n>IL_0019</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>1</span>      <span class=c1>// b
</span><span class=c1></span>    <span class=n>IL_001a</span><span class=p>:</span> <span class=n>xor</span>
    <span class=n>IL_001b</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>
    <span class=c1>// [38 13 - 38 19]
</span><span class=c1></span>    <span class=n>IL_001c</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>    <span class=n>IL_001d</span><span class=p>:</span> <span class=n>volatile</span><span class=p>.</span>
    <span class=n>IL_001f</span><span class=p>:</span> <span class=n>stsfld</span>       <span class=n>int32</span> <span class=n>modreq</span> <span class=p>([</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>]</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>CompilerServices</span><span class=p>.</span><span class=n>IsVolatile</span><span class=p>)</span> <span class=n>SwapBenchmark</span><span class=p>.</span><span class=n>SwapTest</span><span class=p>::</span><span class=n>A</span>

    <span class=c1>// [39 13 - 39 19]
</span><span class=c1></span>    <span class=n>IL_0024</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>1</span>      <span class=c1>// b
</span><span class=c1></span>    <span class=n>IL_0025</span><span class=p>:</span> <span class=n>volatile</span><span class=p>.</span>
    <span class=n>IL_0027</span><span class=p>:</span> <span class=n>stsfld</span>       <span class=n>int32</span> <span class=n>modreq</span> <span class=p>([</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>]</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>CompilerServices</span><span class=p>.</span><span class=n>IsVolatile</span><span class=p>)</span> <span class=n>SwapBenchmark</span><span class=p>.</span><span class=n>SwapTest</span><span class=p>::</span><span class=n>B</span>

    <span class=c1>// [40 9 - 40 10]
</span><span class=c1></span>    <span class=n>IL_002c</span><span class=p>:</span> <span class=n>ret</span>

  <span class=p>}</span> <span class=c1>// end of method SwapTest::SwapXor
</span></code></pre></td></tr></table></div></div><p>The thrid test is finally our tuple-based swap. Surprisingly, it&rsquo;s quite similar to the first one (where the temporary variable was used). First, both static fields <code>A</code> and <code>B</code> are loaded into the local variables <code>a</code> and <code>b</code>, then we have a series of <code>ldloc</code> and <code>stloc</code> instructions which also use a temporary variable called <code>V_2</code> to swap values.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-csharp data-lang=csharp>  <span class=p>.</span><span class=n>method</span> <span class=k>public</span> <span class=n>hidebysig</span> <span class=n>instance</span> <span class=k>void</span>
    <span class=n>SwapTuples</span><span class=p>()</span> <span class=n>cil</span> <span class=n>managed</span>
  <span class=p>{</span>
    <span class=p>.</span><span class=n>custom</span> <span class=n>instance</span> <span class=k>void</span> <span class=p>[</span><span class=n>BenchmarkDotNet</span><span class=p>.</span><span class=n>Annotations</span><span class=p>]</span><span class=n>BenchmarkDotNet</span><span class=p>.</span><span class=n>Attributes</span><span class=p>.</span><span class=n>BenchmarkAttribute</span><span class=p>::.</span><span class=n>ctor</span><span class=p>()</span>
      <span class=p>=</span> <span class=p>(</span><span class=m>01</span> <span class=m>00</span> <span class=m>00</span> <span class=m>00</span> <span class=p>)</span>
    <span class=p>.</span><span class=n>maxstack</span> <span class=m>2</span>
    <span class=p>.</span><span class=n>locals</span> <span class=n>init</span> <span class=p>(</span>
<span class=na>      [0]</span> <span class=n>int32</span> <span class=n>a</span><span class=p>,</span>
<span class=na>      [1]</span> <span class=n>int32</span> <span class=n>b</span><span class=p>,</span>
<span class=na>      [2]</span> <span class=n>int32</span> <span class=n>V_2</span>
    <span class=p>)</span>

    <span class=c1>// [45 13 - 45 23]
</span><span class=c1></span>    <span class=n>IL_0000</span><span class=p>:</span> <span class=n>volatile</span><span class=p>.</span>
    <span class=n>IL_0002</span><span class=p>:</span> <span class=n>ldsfld</span>       <span class=n>int32</span> <span class=n>modreq</span> <span class=p>([</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>]</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>CompilerServices</span><span class=p>.</span><span class=n>IsVolatile</span><span class=p>)</span> <span class=n>SwapBenchmark</span><span class=p>.</span><span class=n>SwapTest</span><span class=p>::</span><span class=n>A</span>
    <span class=n>IL_0007</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>
    <span class=c1>// [46 13 - 46 23]
</span><span class=c1></span>    <span class=n>IL_0008</span><span class=p>:</span> <span class=n>volatile</span><span class=p>.</span>
    <span class=n>IL_000a</span><span class=p>:</span> <span class=n>ldsfld</span>       <span class=n>int32</span> <span class=n>modreq</span> <span class=p>([</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>]</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>CompilerServices</span><span class=p>.</span><span class=n>IsVolatile</span><span class=p>)</span> <span class=n>SwapBenchmark</span><span class=p>.</span><span class=n>SwapTest</span><span class=p>::</span><span class=n>B</span>
    <span class=n>IL_000f</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>1</span>      <span class=c1>// b
</span><span class=c1></span>
    <span class=c1>// [48 13 - 48 29]
</span><span class=c1></span>    <span class=n>IL_0010</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>1</span>      <span class=c1>// b
</span><span class=c1></span>    <span class=n>IL_0011</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>    <span class=n>IL_0012</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>2</span>      <span class=c1>// V_2
</span><span class=c1></span>    <span class=n>IL_0013</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>    <span class=n>IL_0014</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>2</span>      <span class=c1>// V_2
</span><span class=c1></span>    <span class=n>IL_0015</span><span class=p>:</span> <span class=n>stloc</span><span class=p>.</span><span class=m>1</span>      <span class=c1>// b
</span><span class=c1></span>
    <span class=c1>// [50 13 - 50 19]
</span><span class=c1></span>    <span class=n>IL_0016</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>0</span>      <span class=c1>// a
</span><span class=c1></span>    <span class=n>IL_0017</span><span class=p>:</span> <span class=n>volatile</span><span class=p>.</span>
    <span class=n>IL_0019</span><span class=p>:</span> <span class=n>stsfld</span>       <span class=n>int32</span> <span class=n>modreq</span> <span class=p>([</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>]</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>CompilerServices</span><span class=p>.</span><span class=n>IsVolatile</span><span class=p>)</span> <span class=n>SwapBenchmark</span><span class=p>.</span><span class=n>SwapTest</span><span class=p>::</span><span class=n>A</span>

    <span class=c1>// [51 13 - 51 19]
</span><span class=c1></span>    <span class=n>IL_001e</span><span class=p>:</span> <span class=n>ldloc</span><span class=p>.</span><span class=m>1</span>      <span class=c1>// b
</span><span class=c1></span>    <span class=n>IL_001f</span><span class=p>:</span> <span class=n>volatile</span><span class=p>.</span>
    <span class=n>IL_0021</span><span class=p>:</span> <span class=n>stsfld</span>       <span class=n>int32</span> <span class=n>modreq</span> <span class=p>([</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>]</span><span class=n>System</span><span class=p>.</span><span class=n>Runtime</span><span class=p>.</span><span class=n>CompilerServices</span><span class=p>.</span><span class=n>IsVolatile</span><span class=p>)</span> <span class=n>SwapBenchmark</span><span class=p>.</span><span class=n>SwapTest</span><span class=p>::</span><span class=n>B</span>

    <span class=c1>// [52 9 - 52 10]
</span><span class=c1></span>    <span class=n>IL_0026</span><span class=p>:</span> <span class=n>ret</span>

  <span class=p>}</span> <span class=c1>// end of method SwapTest::SwapTuples
</span></code></pre></td></tr></table></div></div><p>In theory, this method is a bit slower because utilizes more IL instructions than in the first example (5 <code>ldloc</code>/5 <code>stloc</code> vs 3 <code>ldloc</code>/3 <code>stloc</code>). Will this affect the final output generated by the JIT? The answer is: no!</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-asm data-lang=asm><span class=c>; SwapBenchmark.SwapTest.SwapTraditional()
</span><span class=c></span>    <span class=nf>mov</span>       <span class=no>eax</span><span class=p>,[</span><span class=mi>7</span><span class=no>FFC4CC5B7AC</span><span class=p>]</span>
    <span class=nf>mov</span>       <span class=no>edx</span><span class=p>,[</span><span class=mi>7</span><span class=no>FFC4CC5B7B0</span><span class=p>]</span>
    <span class=nf>mov</span>       <span class=p>[</span><span class=mi>7</span><span class=no>FFC4CC5B7AC</span><span class=p>],</span><span class=no>edx</span>
    <span class=nf>mov</span>       <span class=p>[</span><span class=mi>7</span><span class=no>FFC4CC5B7B0</span><span class=p>],</span><span class=no>eax</span>
    <span class=nf>ret</span>

<span class=c>; SwapBenchmark.SwapTest.SwapXor()
</span><span class=c></span>    <span class=nf>mov</span>       <span class=no>eax</span><span class=p>,[</span><span class=mi>7</span><span class=no>FFC4CC2B7AC</span><span class=p>]</span>
    <span class=nf>mov</span>       <span class=no>edx</span><span class=p>,[</span><span class=mi>7</span><span class=no>FFC4CC2B7B0</span><span class=p>]</span>
    <span class=nf>xor</span>       <span class=no>eax</span><span class=p>,</span><span class=no>edx</span>
    <span class=nf>xor</span>       <span class=no>edx</span><span class=p>,</span><span class=no>eax</span>
    <span class=nf>xor</span>       <span class=no>eax</span><span class=p>,</span><span class=no>edx</span>
    <span class=nf>mov</span>       <span class=p>[</span><span class=mi>7</span><span class=no>FFC4CC2B7AC</span><span class=p>],</span><span class=no>eax</span>
    <span class=nf>mov</span>       <span class=p>[</span><span class=mi>7</span><span class=no>FFC4CC2B7B0</span><span class=p>],</span><span class=no>edx</span>
    <span class=nf>ret</span>

<span class=c>; SwapBenchmark.SwapTest.SwapTuples()
</span><span class=c></span>    <span class=nf>mov</span>       <span class=no>eax</span><span class=p>,[</span><span class=mi>7</span><span class=no>FFC4CC4B7AC</span><span class=p>]</span>
    <span class=nf>mov</span>       <span class=no>edx</span><span class=p>,[</span><span class=mi>7</span><span class=no>FFC4CC4B7B0</span><span class=p>]</span>
    <span class=nf>mov</span>       <span class=p>[</span><span class=mi>7</span><span class=no>FFC4CC4B7AC</span><span class=p>],</span><span class=no>edx</span>
    <span class=nf>mov</span>       <span class=p>[</span><span class=mi>7</span><span class=no>FFC4CC4B7B0</span><span class=p>],</span><span class=no>eax</span>
    <span class=nf>ret</span></code></pre></td></tr></table></div></div><p>Both first and third tests have exactly the same outputs - we can see that they have been optimized to use fast registers instead of using a slower stack. So the most important conclusion is: using tuples to swap values is exactly as fast as using a temporary variable.</p><p>The method which uses XOR operations is a bit more complex - three additional <code>xor</code> instructions won&rsquo;t speed up the whole process for sure. In the next chapter, we will do a more life example with a real algorithm to check the times.</p><h2 id=bubble-sort>Bubble sort</h2><p>One of the best algorithms to test the execution time of swaps is a bubble sort, so we will use it to check the performance of our three methods. In this benchmark, there are three tests where each performs a sort for the array with 10000 elements (initialized with values from 10000 to 1 to get the most pessimistic case).</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span><span class=lnt>86
</span><span class=lnt>87
</span><span class=lnt>88
</span><span class=lnt>89
</span><span class=lnt>90
</span><span class=lnt>91
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-csharp data-lang=csharp><span class=k>using</span> <span class=nn>System.Linq</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>BenchmarkDotNet.Attributes</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>BenchmarkDotNet.Jobs</span><span class=p>;</span>
<span class=k>using</span> <span class=nn>BenchmarkDotNet.Running</span><span class=p>;</span>

<span class=k>namespace</span> <span class=nn>BubbleSortSwapBenchmark</span>
<span class=p>{</span>
<span class=na>    [DisassemblyDiagnoser]</span>
<span class=na>    [SimpleJob(RuntimeMoniker.NetCoreApp31)]</span>
    <span class=k>public</span> <span class=k>class</span> <span class=nc>BubbleSortSwapTest</span>
    <span class=p>{</span>
        <span class=k>private</span> <span class=k>const</span> <span class=kt>int</span> <span class=n>N</span> <span class=p>=</span> <span class=m>10000</span><span class=p>;</span>
<span class=na>
</span><span class=na>        [Benchmark]</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>BubbleSortSwapTraditional</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=kt>var</span> <span class=n>array</span> <span class=p>=</span> <span class=n>Enumerable</span><span class=p>.</span><span class=n>Range</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>N</span><span class=p>).</span><span class=n>Reverse</span><span class=p>().</span><span class=n>ToArray</span><span class=p>();</span>
            <span class=kt>var</span> <span class=n>sorted</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>

            <span class=k>while</span> <span class=p>(!</span><span class=n>sorted</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=n>sorted</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>

                <span class=k>for</span> <span class=p>(</span><span class=kt>var</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>array</span><span class=p>.</span><span class=n>Length</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
                <span class=p>{</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>array</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=n>array</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>])</span>
                    <span class=p>{</span>
                        <span class=kt>var</span> <span class=n>temp</span> <span class=p>=</span> <span class=n>array</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
                        <span class=n>array</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>=</span> <span class=n>array</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>];</span>
                        <span class=n>array</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>=</span> <span class=n>temp</span><span class=p>;</span>

                        <span class=n>sorted</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
<span class=na>
</span><span class=na>        [Benchmark]</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>BubbleSortSwapXor</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=kt>var</span> <span class=n>array</span> <span class=p>=</span> <span class=n>Enumerable</span><span class=p>.</span><span class=n>Range</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>N</span><span class=p>).</span><span class=n>Reverse</span><span class=p>().</span><span class=n>ToArray</span><span class=p>();</span>
            <span class=kt>var</span> <span class=n>sorted</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>

            <span class=k>while</span> <span class=p>(!</span><span class=n>sorted</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=n>sorted</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>

                <span class=k>for</span> <span class=p>(</span><span class=kt>var</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>array</span><span class=p>.</span><span class=n>Length</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
                <span class=p>{</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>array</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=n>array</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>])</span>
                    <span class=p>{</span>
                        <span class=n>array</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>^=</span> <span class=n>array</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>];</span>
                        <span class=n>array</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>]</span> <span class=p>^=</span> <span class=n>array</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
                        <span class=n>array</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>^=</span> <span class=n>array</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>];</span>

                        <span class=n>sorted</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
<span class=na>
</span><span class=na>        [Benchmark]</span>
        <span class=k>public</span> <span class=k>void</span> <span class=n>BubbleSortSwapTuples</span><span class=p>()</span>
        <span class=p>{</span>
            <span class=kt>var</span> <span class=n>array</span> <span class=p>=</span> <span class=n>Enumerable</span><span class=p>.</span><span class=n>Range</span><span class=p>(</span><span class=m>0</span><span class=p>,</span> <span class=n>N</span><span class=p>).</span><span class=n>Reverse</span><span class=p>().</span><span class=n>ToArray</span><span class=p>();</span>
            <span class=kt>var</span> <span class=n>sorted</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>

            <span class=k>while</span> <span class=p>(!</span><span class=n>sorted</span><span class=p>)</span>
            <span class=p>{</span>
                <span class=n>sorted</span> <span class=p>=</span> <span class=k>true</span><span class=p>;</span>

                <span class=k>for</span> <span class=p>(</span><span class=kt>var</span> <span class=n>i</span> <span class=p>=</span> <span class=m>0</span><span class=p>;</span> <span class=n>i</span> <span class=p>&lt;</span> <span class=n>array</span><span class=p>.</span><span class=n>Length</span> <span class=p>-</span> <span class=m>1</span><span class=p>;</span> <span class=n>i</span><span class=p>++)</span>
                <span class=p>{</span>
                    <span class=k>if</span> <span class=p>(</span><span class=n>array</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=p>&gt;</span> <span class=n>array</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>])</span>
                    <span class=p>{</span>
                        <span class=p>(</span><span class=n>array</span><span class=p>[</span><span class=n>i</span><span class=p>],</span> <span class=n>array</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>])</span> <span class=p>=</span> <span class=p>(</span><span class=n>array</span><span class=p>[</span><span class=n>i</span> <span class=p>+</span> <span class=m>1</span><span class=p>],</span> <span class=n>array</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
                        <span class=n>sorted</span> <span class=p>=</span> <span class=k>false</span><span class=p>;</span>
                    <span class=p>}</span>
                <span class=p>}</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>class</span> <span class=nc>Program</span>
    <span class=p>{</span>
        <span class=k>public</span> <span class=k>static</span> <span class=k>void</span> <span class=n>Main</span><span class=p>(</span><span class=kt>string</span><span class=p>[]</span> <span class=n>args</span><span class=p>)</span>
        <span class=p>{</span>
            <span class=n>BenchmarkRunner</span><span class=p>.</span><span class=n>Run</span><span class=p>&lt;</span><span class=n>BubbleSortSwapTest</span><span class=p>&gt;();</span>
        <span class=p>}</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><pre><code>BenchmarkDotNet=v0.12.1, OS=Windows 10.0.18363.959 (1909/November2018Update/19H2)
Intel Core i5-8300H CPU 2.30GHz (Coffee Lake), 1 CPU, 8 logical and 4 physical cores
.NET Core SDK=5.0.100-preview.5.20279.10
  [Host]        : .NET Core 3.1.6 (CoreCLR 4.700.20.26901, CoreFX 4.700.20.31603), X64 RyuJIT
  .NET Core 3.1 : .NET Core 3.1.6 (CoreCLR 4.700.20.26901, CoreFX 4.700.20.31603), X64 RyuJIT

Job=.NET Core 3.1  Runtime=.NET Core 3.1
</code></pre><table><thead><tr><th>Method</th><th align=right>Mean</th><th align=right>Error</th><th align=right>StdDev</th><th align=right>Code Size</th></tr></thead><tbody><tr><td>BubbleSortSwapTraditional</td><td align=right>91.88 ms</td><td align=right>0.355 ms</td><td align=right>0.315 ms</td><td align=right>522 B</td></tr><tr><td>BubbleSortSwapXor</td><td align=right>133.82 ms</td><td align=right>0.668 ms</td><td align=right>0.624 ms</td><td align=right>540 B</td></tr><tr><td>BubbleSortSwapTuples</td><td align=right>91.33 ms</td><td align=right>0.359 ms</td><td align=right>0.336 ms</td><td align=right>528 B</td></tr></tbody></table><p>The results are clear and valid with our earlier observations: both traditional and tuple-based swaps have exactly the same performance (differences in the mean time are within the error margin).</p><h2 id=summary>Summary</h2><p>Sometimes, it&rsquo;s not easy to tell if some solution has performance overhead, especially when we think about JIT with its complex optimization processes. As we saw in this article, a tuple-based algorithm is an excellent way to swap two elements, providing better readability and the same performance as the traditional algorithm using a temporary variable. Definitely worth to try and use in our projects.</p></div><footer class=post__footer><div class="post__tags tags clearfix"><svg class="tags__badge icon icon-tag" width="16" height="16" viewBox="0 0 32 32"><path d="M32 19c0 1-1 2-1 2L21 31s-1 1-2 1-2-1-2-1L2 16c-1-1-1.4-2-1.4-2S0 12.5.0 11V3C0 1.5.8.8.8.8S1.5.0 3 0h8c1.5.0 3 .6 3 .6S15 1 16 2l15 15s1 1 1 2zM7 10a3 3 0 100-6 3 3 0 000 6z"/></svg><ul class=tags__list><li class=tags__item><a class="tags__link btn" href=/tags/.net/ rel=tag>.NET</a></li></ul></div></footer></article></main><div class="authorbox clearfix"><figure class=authorbox__avatar><img alt="Tearth avatar" src=https://github.com/Tearth.png class=avatar height=90 width=90></figure><div class=authorbox__header><span class=authorbox__name>About Tearth</span></div><div class=authorbox__description>C# programmer. After hours I enjoy writing chess engines, reading about history, space exploration and playing simulators or strategy games. I miss space shuttles.</div></div><nav class="pager flex"><div class="pager__item pager__item--prev"><a class=pager__link href=/posts/mystery-of-random-class-in-net-framework-and-net-core/ rel=prev><span class=pager__subtitle>¬´&#8201;Previous</span><p class=pager__title>Mystery of Random class in .NET Framework and .NET Core</p></a></div><div class="pager__item pager__item--next"><a class=pager__link href=/posts/performance-of-chess-engines-written-in-csharp-part-1/ rel=next><span class=pager__subtitle>Next&#8201;¬ª</span><p class=pager__title>Performance of chess engines written in C#, part 1</p></a></div></nav></div><aside class=sidebar><div class="widget-categories widget"><h4 class=widget__title>Bitboard viewer</h4><div class=widget__content><a href=https://tearth.dev/bitboard-viewer/ alt="Bitboard viewer">https://tearth.dev/bitboard-viewer/</a></div></div><div class="widget-categories widget"><h4 class=widget__title>Chess engines</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=https://github.com/Tearth/Inanis><span class=project-title>Inanis</span> - the strongest one, under development</a><div class=project-details><b>Elo: 2950</b>, Language: Rust, SLOC: 10000</div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=LinkedIn rel="noopener noreferrer" href=https://lichess.org/@/InanisBot target=_blank><span>Play with Inanis on lichess.org</span></a></div></li><li class=widget__item><a class=widget__link href=https://github.com/Tearth/Cosette><span class=project-title>Cosette</span> - one of the best .NET engines</a><div class=project-details><b>Elo: 2500</b>, Language: C#, SLOC: 12000</div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=LinkedIn rel="noopener noreferrer" href=https://lichess.org/@/CosetteBot target=_blank><span>Play with Cosette on lichess.org</span></a></div></li><li class=widget__item><a class=widget__link href=https://github.com/Tearth/Proxima-b-2.0><span class=project-title>Proxima b 2.0</span> - made as part of BSc Thesis</a><div class=project-details><b>Elo: 1600</b>, Language: C#, SLOC: 10000</div></li><li class=widget__item><a class=widget__link href=https://github.com/Tearth/Proxima-b><span class=project-title>Proxima b 1.0</span> - the weakest and simplest one</a><div class=project-details><b>Elo: 1000</b>, Language: C++, SLOC: 4000</div></li></ul></div></div><div class="widget-categories widget"><h4 class=widget__title>Other projects</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=https://github.com/skni-kod/MicrOS><span class=project-title>MicrOS</span> - 32-bit operating system</a><div class=project-details>Language: C, Assembly. SLOC: 40000</div></li><li class=widget__item><a class=widget__link href=https://github.com/Tearth/Lemao><span class=project-title>Lemao</span> - game engine made from scratch</a><div class=project-details>Language: Rust. SLOC: 15000</div></li><li class=widget__item><a class=widget__link href=https://github.com/Tearth/DotNet6502><span class=project-title>DotNet6502</span> - modular MOS 6502 emulator</a><div class=project-details>Language: C#. SLOC: 6000</div></li><li class=widget__item><a class=widget__link href=https://github.com/Tearth/Oddity><span class=project-title>Oddity</span> - unofficial SpaceX API wrapper</a><div class=project-details>Language: C#. SLOC: 3000</div></li></ul><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=LinkedIn rel="noopener noreferrer" href="https://github.com/Tearth?tab=repositories" target=_blank><span>Full list of repositories</span></a></div></div></div><div class="widget-categories widget"><h4 class=widget__title>Categories</h4><div class=widget__content><ul class=widget__list><li class=widget__item><a class=widget__link href=/categories/.net-internals/>.NET internals (6)</a></li><li class=widget__item><a class=widget__link href=/categories/chess-engines/>Chess engines (10)</a></li><li class=widget__item><a class=widget__link href=/categories/performance-comparisons/>Performance comparisons (4)</a></li></ul></div></div><div class="widget-taglist widget"><h4 class=widget__title>Tags</h4><div class=widget__content><a class="widget-taglist__link widget__link btn" href=/tags/.net/ title=.NET>.NET (9)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/assembly/ title=Assembly>Assembly (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/bmi/ title=BMI>BMI (1)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/chess/ title=Chess>Chess (10)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/clr/ title=CLR>CLR (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/gethashcode/ title=GetHashCode>GetHashCode (2)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/inanis/ title=Inanis>Inanis (7)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/releases/ title=Releases>Releases (7)</a>
<a class="widget-taglist__link widget__link btn" href=/tags/rust/ title=Rust>Rust (1)</a></div></div><div class="widget-social widget"><h4 class="widget-social__title widget__title">Social</h4><div class="widget-social__content widget__content"><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=GitHub rel="noopener noreferrer" href=https://github.com/Tearth target=_blank><svg class="widget-social__link-icon icon icon-github" width="24" height="24" viewBox="0 0 384 374"><path d="m192 0C85.9.0.0 85.8.0 191.7c0 84.7 55 156.6 131.3 181.9 9.6 1.8 13.1-4.2 13.1-9.2.0-4.6-.2-16.6-.3-32.6-53.4 11.6-64.7-25.7-64.7-25.7-8.7-22.1-21.3-28-21.3-28-17.4-11.9 1.3-11.6 1.3-11.6 19.3 1.4 29.4 19.8 29.4 19.8 17.1 29.3 44.9 20.8 55.9 15.9 1.7-12.4 6.7-20.8 12.2-25.6-42.6-4.8-87.5-21.3-87.5-94.8.0-20.9 7.5-38 19.8-51.4-2-4.9-8.6-24.3 1.9-50.7.0.0 16.1-5.2 52.8 19.7 15.3-4.2 31.7-6.4 48.1-6.5 16.3.1 32.7 2.2 48.1 6.5 36.7-24.8 52.8-19.7 52.8-19.7 10.5 26.4 3.9 45.9 1.9 50.7 12.3 13.4 19.7 30.5 19.7 51.4.0 73.7-44.9 89.9-87.7 94.6 6.9 5.9 13 17.6 13 35.5.0 25.6-.2 46.3-.2 52.6.0 5.1 3.5 11.1 13.2 9.2 76.2-25.5 131.2-97.3 131.2-182 0-105.9-86-191.7-192-191.7z"/></svg><span>GitHub</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=Twitter rel="noopener noreferrer" href=https://twitter.com/TearthDev target=_blank><svg class="widget-social__link-icon icon icon-twitter" width="24" height="24" viewBox="0 0 384 312"><path d="m384 36.9c-14.1 6.3-29.3 10.5-45.2 12.4 16.3-9.7 28.8-25.2 34.6-43.6-15.2 9-32.1 15.6-50 19.1-14.4-15.2-34.9-24.8-57.5-24.8-43.5.0-78.8 35.3-78.8 78.8.0 6.2.7 12.2 2 17.9-65.5-3.3-123.5-34.6-162.4-82.3-6.7 11.6-10.6 25.2-10.6 39.6.0 27.3 13.9 51.4 35 65.6-12.9-.4-25.1-4-35.7-9.9v1c0 38.2 27.2 70 63.2 77.2-6.6 1.8-13.6 2.8-20.8 2.8-5.1.0-10-.5-14.8-1.4 10 31.3 39.1 54.1 73.6 54.7-27 21.1-60.9 33.7-97.8 33.7-6.4.0-12.6-.4-18.8-1.1 34.9 22.4 76.3 35.4 120.8 35.4 144.9.0 224.1-120 224.1-224.1.0-3.4-.1-6.8-.2-10.2 15.4-11.1 28.7-25 39.3-40.8z"/></svg><span>Twitter</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=Lichess rel="noopener noreferrer" href=https://lichess.org/@/Tearth target=_blank><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" class="widget-social__link-icon icon icon-lichess" width="24" height="24" viewBox="2 3 21 21"><g id="surface1"><path style="fill-rule:evenodd;fill:#fff;fill-opacity:1;stroke-width:0" d="M22.001953 9.997559C32.497559 11.000977 38.503418 18.00293 37.998047 39.001465H15C15 30 24.997559 32.497559 22.998047 18.00293" transform="matrix(0.533333,0,0,0.533333,0,0)"/><path style="fill-rule:evenodd;fill:#fff;fill-opacity:1;stroke-width:0" d="M24.001465 18.00293C24.382324 20.910645 18.449707 25.371094 16.003418 26.99707 13.000488 28.996582 13.183594 31.340332 11.000977 31.003418 9.960938 30.058594 12.407227 27.956543 11.000977 28.000488 9.997559 28.000488 11.191406 29.230957 9.997559 30 9.001465 30 5.998535 31.003418 5.998535 26.000977 5.998535 24.001465 11.99707 13.996582 11.99707 13.996582S13.886719 12.099609 13.996582 10.50293C13.271484 9.506836 13.498535 8.503418 13.498535 7.5 14.501953 6.496582 16.501465 9.997559 16.501465 9.997559H18.500977S19.277344 8.005371 20.998535 7.001953L22.001953 9.997559" transform="matrix(0.533333,0,0,0.533333,0,0)"/><path style="fill-rule:evenodd;fill:#000;fill-opacity:1;stroke-width:0" d="M9.499512 25.50293C9.499512 25.773926 9.279785 26.000977 9.001465 26.000977 8.723145 26.000977 8.503418 25.773926 8.503418 25.50293 8.503418 25.224609 8.723145 24.997559 9.001465 24.997559 9.279785 24.997559 9.499512 25.224609 9.499512 25.50293zm0 0" transform="matrix(0.533333,0,0,0.533333,0,0)"/><path style="fill-rule:evenodd;fill:#000;fill-opacity:1;stroke-width:0" d="M14.999472 15.496922C14.996821 16.32729 14.774506 16.996929 14.499265 17.003609 14.226704 17.000284 13.999306 16.328111 14.001958 15.497742 13.998266 14.671036 14.22058 14.001397 14.499484 14.00106 14.778388 14.000723 14.995781 14.670215 14.999472 15.496922zm0 0" transform="matrix(0.461867,0.266667,-0.266667,0.461867,5.1696,-2.758933)"/></g></svg><span>Lichess</span></a></div><div class="widget-social__item widget__item"><a class="widget-social__link widget__link btn" title=Email href=mailto:tearthdev@gmail.com><svg class="widget-social__link-icon icon icon-mail" width="24" height="24" viewBox="0 0 416 288"><path d="m0 16v256 16h16 384 16v-16V16 0h-16H16 0zm347 16-139 92.5L69 32zM199 157.5l9 5.5 9-5.5L384 46v210H32V46z"/></svg><span>E-Mail</span></a></div></div></div></aside></div><footer class=footer><div class="container footer__container flex"><div class=footer__copyright>&copy; 2024 Tearth.
<span class=footer__copyright-credits>Generated with <a href=https://gohugo.io/ rel="nofollow noopener" target=_blank>Hugo</a> and <a href=https://github.com/Vimux/Mainroad/ rel="nofollow noopener" target=_blank>Mainroad</a> theme, hosted on <a href=https://pages.github.com/ rel="nofollow noopener" target=_blank>pages.github.com</a>.</span></div></div></footer></div></body></html>